<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beleggingsclub Portefeuille</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .open-group-btn[disabled] { border-color: #cbd5f5; color: #94a3b8; background: #f8fafc; cursor: not-allowed; }
        .form-label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; margin-bottom: 0.35rem; }
        .form-input { width: 100%; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.65rem 0.9rem; font-size: 0.95rem; color: #0f172a; background: #fff; }
        .form-input:disabled { background: #f8fafc; color: #94a3b8; }
        .form-input[readonly] { border-color: #cbd5f5; border-style: dashed; background: #f8fbff; font-weight: 600; }
        .quote-pill { border: 1px dashed #cbd5f5; border-radius: 0.75rem; padding: 0.65rem 0.9rem; background: #f8fbff; font-weight: 600; color: #0f172a; }
        .btn-secondary { border: 1px solid #cbd5f5; padding: 0.6rem 1.1rem; border-radius: 999px; font-weight: 600; color: #1d4ed8; background: #eff6ff; }
        .btn-primary { background-color: #2563eb; color: white; padding: 0.6rem 1.1rem; border-radius: 999px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .prose h3 { font-size: 1.1rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #1e293b; }
        .prose p { margin-bottom: 0.8rem; line-height: 1.5; color: #475569; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; color: #475569; }
        .prose strong { color: #0f172a; font-weight: 600; }
    </style>
</head>
<body class="text-slate-800">

    {% include '_nav.html' %}

    <!-- Global Toast Container -->
    <div id="toast-root" class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none"></div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <div class="flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-slate-400">
                    <span>Portefeuille</span>
                    {% if active_group %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 tracking-normal">
                        <i data-lucide="layers" class="h-3.5 w-3.5"></i>
                        {{ active_group.name }}
                        {% if is_host %}
                            <span class="ml-2 bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-200">HOST</span>
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Overzicht per groep</h1>
                <p class="text-slate-500 text-sm">Selecteer een groep om zijn portefeuille en rendement te bekijken.</p>
            </div>
            
            <div class="flex gap-2">
                {% if active_group %}
                <button id="ai-scan-btn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 border border-purple-600 rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors shadow-sm text-white">
                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                    AI Portefeuille Scan
                </button>
                <a href="{{ url_for('transacties.transactions') }}" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors shadow-sm text-slate-700">
                    <i data-lucide="list" class="h-4 w-4"></i>
                    Transacties
                </a>
                
                {% else %}
                <button onclick="window.location.reload()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors shadow-sm text-slate-700">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                    Verversen
                </button>
                {% endif %}
            </div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-8">
              {% for category, message in messages %}
                <div class="p-4 rounded-lg flex items-center gap-2 {{ 'bg-emerald-100 text-emerald-800 border border-emerald-200' if category == 'success' else 'bg-rose-100 text-rose-800 border border-rose-200' }}">
                   {% if category == 'success' %}
                     <i data-lucide="check-circle" class="h-5 w-5"></i>
                   {% else %}
                     <i data-lucide="alert-circle" class="h-5 w-5"></i>
                   {% endif %}
                   <span class="font-medium">{{ message }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% set builder_disabled = 'disabled' if not active_group else '' %}

        <div class="glass-card p-5 mb-8">
            {% if user_groups %}
            <div class="flex flex-col gap-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <p class="text-xs text-slate-400 uppercase tracking-[0.25em]">Jouw groepen</p>
                        <p class="text-sm text-slate-500">Klik op een groep om die portefeuille te openen.</p>
                    </div>
                    <p class="text-sm text-slate-500">{{ user_groups|length }} groep{% if (user_groups|length) != 1 %}en{% endif %}</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    {% for group in user_groups %}
                    <form method="post" action="{{ url_for('groups.select_group', group_id=group.id) }}">
                        <button type="submit" class="px-4 py-2 rounded-full border text-sm font-semibold transition-colors flex items-center gap-2 {% if group.is_current %}bg-blue-600 text-white border-blue-600{% else %}border-slate-200 text-slate-600 hover:border-blue-300 hover:text-blue-700{% endif %}" {% if group.is_current %}disabled{% endif %}>
                            <i data-lucide="shield" class="h-4 w-4"></i>
                            {{ group.name or "Onbekend" }}
                            {% if group.is_current %}
                            <span class="text-xs uppercase tracking-wide">Actief</span>
                            {% endif %}
                        </button>
                    </form>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-6">
                <p class="text-lg font-semibold text-slate-900">Nog geen groep gevonden</p>
                <p class="text-slate-500 text-sm">Maak een nieuwe groep aan of sluit je aan via de homepagina.</p>
                <div class="mt-4 flex justify-center gap-3">
                    <a href="{{ url_for('groups.create_group') }}" class="px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold">Nieuwe groep</a>
                    <a href="{{ url_for('groups.join_group') }}" class="px-4 py-2 rounded-full border border-slate-200 text-sm font-semibold text-slate-700">Aansluiten</a>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="glass-card p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Portefeuille samenstellen</p>
                    <h2 class="text-xl font-bold text-slate-900">Voeg posities toe aan de actieve groep</h2>
                    <p class="text-slate-500 text-sm">Gebruik Yahoo Finance voor actuele koersen en details.</p>
                </div>
                <div class="flex gap-2 items-center">
                    {% if active_group %}
                        {% if is_host %}
                        
                        {% endif %}
                    {% else %}
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-sm">
                            <i data-lucide="info" class="h-4 w-4"></i>
                            Selecteer eerst een groep
                        </span>
                    {% endif %}
                </div>
            </div>

            {% if is_host %}
            <form id="position-form" class="space-y-5">
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Transactie</label>
                        <select id="transaction-type" class="form-input">
                            <option value="BUY">Aankoop</option>
                            <option value="SELL">Verkoop</option>
                            <option value="DIVIDEND">Dividend</option>
                            <option value="TRANSFER">Overschrijving</option>
                            <option value="PAYOUT">Uitbetaling effecten</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <div id="txn-placeholder" class="hidden quote-pill text-slate-400">Velden voor deze transactie verschijnen hier.</div>
                    </div>
                </div>

                <div id="buy-section">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Ticker</label>
                        <div class="flex gap-2">
                            <input id="ticker-input" type="text" class="form-input flex-1" placeholder="vb. AAPL" {{ builder_disabled }}>
                            <button type="button" id="lookup-ticker" class="btn-secondary" {{ builder_disabled }}>
                                <i data-lucide="search" class="h-4 w-4"></i>
                                Zoek
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Aantal aandelen</label>
                        <input id="quantity-input" type="number" step="0.01" min="0" class="form-input" placeholder="0" {{ builder_disabled }}>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Laatste koers (wijzigbaar)</label>
                        <input id="quote-price-input" type="number" step="any" min="0" class="form-input" placeholder="0" {{ builder_disabled }}>
                    </div>
                    <div>
                        <label class="form-label">Sector</label>
                        <div id="quote-sector" class="quote-pill">—</div>
                    </div>
                    <div>
                        <label class="form-label">Beursvaluta</label>
                        <input id="currency-input" list="currency-list" class="form-input" placeholder="Bijv. EUR" maxlength="6" {{ builder_disabled }}>
                        <datalist id="currency-list">
                            <option value="EUR"></option>
                            <option value="USD"></option>
                            <option value="GBP"></option>
                            <option value="CHF"></option>
                            <option value="CAD"></option>
                            <option value="JPY"></option>
                            <option value="SEK"></option>
                            <option value="NOK"></option>
                            <option value="PLN"></option>
                            <option value="DKK"></option>
                        </datalist>
                        <div id="currency-hint" class="text-[11px] mt-1 text-slate-400">Automatisch gevuld vanuit Yahoo Finance; overschrijf indien nodig (2–6 letters).</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mt-2">
                    <div>
                        <label class="form-label">Transactiedatum</label>
                        <input id="transaction-date" type="date" class="form-input" {{ builder_disabled }}>
                        <div class="text-[11px] mt-1 text-slate-400">Standaard vandaag; pas aan indien nodig.</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Naam</label>
                        <div id="quote-name" class="quote-pill">—</div>
                    </div>
                    <div>
                        <label class="form-label">Status</label>
                        <div id="form-status" class="quote-pill text-slate-400">{{ 'Selecteer eerst een groep' if not active_group else 'Zoek een ticker om details te laden' }}</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mt-2">
                    <div>
                        <label class="form-label">Bruto totaal (koers × aantal)</label>
                        <input id="gross-total" type="number" step="0.01" class="form-input" placeholder="€ 0,00" readonly>
                    </div>
                    <div>
                        <label id="total-label" class="form-label">Totaal in beursvaluta</label>
                        <input id="final-total" type="number" step="0.01" min="0" class="form-input" placeholder="€ 0,00" {{ builder_disabled }}>
                    </div>
                    <div>
                        <label id="cost-label" class="form-label">Kosten (TOTAAL − Bruto)</label>
                        <input id="derived-cost" type="number" step="0.01" class="form-input" placeholder="€ 0,00" readonly>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mt-2">
                    <div>
                        <label class="form-label">Kosten in euro</label>
                        <input id="fee-eur" type="number" step="0.01" class="form-input" placeholder="€ 0,00" readonly>
                        <div class="text-[11px] mt-1 text-slate-400">Afgeleid: kosten in eigen munt omgezet naar EUR via WK.</div>
                    </div>
                </div>

                <div id="currency-extra" class="grid md:grid-cols-3 gap-4 mt-2 hidden">
                    <div>
                        <label class="form-label">Totaal in euro</label>
                        <input id="final-total-eur" type="number" step="0.01" min="0" class="form-input" placeholder="€ 0,00" {{ builder_disabled }}>
                    </div>
                    <div>
                        <label class="form-label">WK</label>
                        <input id="wk-output" type="number" step="0.0001" class="form-input" placeholder="1.0000" readonly>
                        <div class="text-[11px] mt-1 text-slate-400">Wisselkoers = eigen munt / euro</div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit" id="position-submit" class="btn-primary" {{ builder_disabled }}>
                        <i data-lucide="plus-circle" class="h-4 w-4"></i>
                        Transactie opslaan
                    </button>
                </div>
                </div>
            </form>
            {% else %}
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
                <i data-lucide="lock" class="h-8 w-8 text-slate-400 mx-auto mb-3"></i>
                <h3 class="text-lg font-semibold text-slate-700">Alleen-lezen modus</h3>
                <p class="text-slate-500 mt-2">Je bekijkt deze portefeuille als lid. Alleen hosts kunnen transacties toevoegen of bewerken.</p>
            </div>
            {% endif %}
        </div>

        {% if not active_group %}
        <div class="bg-white border border-dashed border-slate-200 rounded-2xl p-8 text-center text-slate-500">
            Selecteer eerst een groep om een portefeuille te bekijken.
        </div>
        {% endif %}

        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-400 text-red-700 px-4 py-3 rounded shadow-sm mb-6">
            <strong class="font-bold">Fout!</strong> <span id="error-text"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 bg-gradient-to-br from-blue-600 to-blue-700 text-white border-none">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-blue-100 text-sm font-medium mb-1">Totale Waarde</p>
                        <h2 id="total-value" class="text-3xl font-bold">Laden...</h2>
                    </div>
                    <div class="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                        <i data-lucide="wallet" class="h-6 w-6 text-white"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span class="bg-white/20 px-2 py-1 rounded text-xs font-medium backdrop-blur-sm">
                        <span id="position-count">0</span> posities
                    </span>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium mb-1">Totaal Rendement</p>
                        <h2 id="total-gain" class="text-3xl font-bold text-slate-900">...</h2>
                    </div>
                    <div class="p-2 bg-slate-100 rounded-lg">
                        <i data-lucide="bar-chart-2" class="h-6 w-6 text-slate-600"></i>
                    </div>
                </div>
                <div id="gain-badge" class="mt-4 inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600">
                    <span id="gain-percent">0%</span>
                </div>
            </div>

            <div class="glass-card p-6 space-y-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium mb-1">Beschikbare Cash</p>
                        <h2 id="cash-balance" class="text-3xl font-bold text-slate-900">€ 0,00</h2>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg">
                        <i data-lucide="piggy-bank" class="h-6 w-6 text-emerald-600"></i>
                    </div>
                </div>
                <p id="cash-status" class="text-slate-400 text-xs">Klaar om te investeren</p>
                
                {% if is_host %}
                <div class="flex flex-col gap-2">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input id="cash-adjust-input" type="number" step="0.01" min="0" class="form-input flex-1" placeholder="Bedrag" {{ builder_disabled }}>
                        <div class="flex gap-2">
                            <button id="cash-add-btn" type="button" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700" {{ builder_disabled }}>+ Cash</button>
                            <button id="cash-remove-btn" type="button" class="px-3 py-2 rounded-lg bg-rose-600 text-white text-sm font-semibold hover:bg-rose-700" {{ builder_disabled }}>- Cash</button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400">Gebruik deze knoppen voor stortingen of opnames buiten de app.</p>
                </div>
                {% endif %}
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium mb-1">Gerealiseerde Winst/Verlies</p>
                        <h2 id="realized-profit" class="text-3xl font-bold text-slate-900">€ 0,00</h2>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg">
                        <i data-lucide="check-circle" class="h-6 w-6 text-indigo-600"></i>
                    </div>
                </div>
                <p id="realized-count" class="text-slate-400 text-xs">inclusief dividenden</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="glass-card p-6 flex flex-col lg:col-span-1">
                <h3 class="font-bold text-slate-900 mb-6 flex items-center gap-2">
                    <i data-lucide="pie-chart" class="h-5 w-5 text-slate-400"></i>
                    Sector Allocatie
                </h3>
                <div class="flex-grow flex items-center justify-center relative h-64 w-full">
                    <canvas id="sectorChart"></canvas>
                </div>
                <div class="mt-4 text-center text-xs text-slate-400">
                    Verdeling van portefeuillewaarde
                </div>
            </div>

            <div class="glass-card overflow-hidden lg:col-span-2 flex flex-col">
                <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="list" class="h-5 w-5 text-slate-400"></i>
                        Huidige Posities
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="refresh-all-btn" type="button" class="px-3 py-1.5 rounded-lg bg-white border border-slate-300 text-slate-700 text-xs font-semibold hover:bg-slate-50">
                            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                            Ververs
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-semibold uppercase tracking-wider text-xs">
                            <tr>
                                <th class="px-6 py-4">Ticker</th>
                                <th class="px-6 py-4">Sector</th>
                                <th class="px-6 py-4">Munt</th>
                                <th class="px-6 py-4 text-right">Aantal</th>
                                <th class="px-6 py-4 text-right">Koers in beursvaluta</th>
                                <th class="px-6 py-4 text-right">WK</th>
                                <th class="px-6 py-4 text-right">Koers in euro</th>
                                <th class="px-6 py-4 text-right">Waarde</th>
                                <th class="px-6 py-4 text-right">Winst</th>
                                <th class="px-6 py-4 text-right">Acties</th>
                            </tr>
                        </thead>
                        <tbody id="portfolio-table-body" class="divide-y divide-slate-100 bg-white">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="trade-modal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-slate-900/60" data-close-trade></div>
        <div class="relative mx-auto mt-20 w-full max-w-lg px-4">
            <div class="glass-card p-6 relative">
                <button type="button" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" data-close-trade>
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
                <div class="mb-4">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-400" id="trade-modal-label">Transactie</p>
                    <h3 id="trade-modal-title" class="text-xl font-bold text-slate-900">Kopen</h3>
                </div>
                <form id="trade-form" class="space-y-4">
                    <div>
                        <label class="form-label">Ticker</label>
                        <div id="trade-ticker" class="quote-pill font-semibold">—</div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Aantal aandelen</label>
                            <input id="trade-quantity" type="number" step="0.01" min="0" class="form-input" placeholder="0">
                        </div>
                        <div>
                            <label class="form-label">Prijs per aandeel (€)</label>
                            <input id="trade-price" type="number" step="0.01" min="0" class="form-input" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Transactiekost (EUR)</label>
                        <input id="trade-fee" type="number" step="0.01" min="0" class="form-input" placeholder="0">
                    </div>
                    <p id="trade-info" class="text-xs text-slate-400">—</p>
                    <div id="trade-status" class="text-xs text-slate-400">Vul de velden in en bevestig.</div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-semibold text-slate-600 hover:bg-slate-50" data-close-trade>Annuleren</button>
                        <button id="trade-submit" type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Bevestigen</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="ai-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-slate-900/75" aria-hidden="true" onclick="closeAiModal()"></div>

            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="bot" class="h-6 w-6 text-purple-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-slate-900" id="ai-modal-title">AI Analyse</h3>
                            <div class="mt-4">
                                <div id="ai-content" class="text-sm text-slate-500 prose max-w-none">
                                    <div class="flex justify-center py-8">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeAiModal()">
                        Sluiten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const eur = new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' });

        const SUPABASE_URL = "{{ supabase_url }}";
        const SUPABASE_KEY = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const ACTIVE_GROUP_ID = Number('{{ active_group.id if active_group else "" }}') || null;
        
        // HOST CONSTANTE: Dit bepaalt of JS knoppen toont
        const IS_HOST = {{ 'true' if is_host else 'false' }};

        const tickerInput = document.getElementById('ticker-input');
        const quantityInput = document.getElementById('quantity-input');
        const lookupBtn = document.getElementById('lookup-ticker');
        const positionForm = document.getElementById('position-form');
        const txnTypeSelect = document.getElementById('transaction-type');
        const txnPlaceholder = document.getElementById('txn-placeholder');
        const buySection = document.getElementById('buy-section');
        const positionSubmitBtn = document.getElementById('position-submit');
        const quoteNameEl = document.getElementById('quote-name');
        const quoteSectorEl = document.getElementById('quote-sector');
        const quotePriceInput = document.getElementById('quote-price-input');
        const currencyInput = document.getElementById('currency-input');
        const transactionDateInput = document.getElementById('transaction-date');
        const formStatusEl = document.getElementById('form-status');
        const transactionCostInput = null; 
        const grossTotalInput = document.getElementById('gross-total');
        const finalTotalInput = document.getElementById('final-total');
        const derivedCostInput = document.getElementById('derived-cost');
        const feeEurInput = document.getElementById('fee-eur');
        const cashAdjustInput = document.getElementById('cash-adjust-input');
        const cashAddBtn = document.getElementById('cash-add-btn');
        const cashRemoveBtn = document.getElementById('cash-remove-btn');
        const tradeModal = document.getElementById('trade-modal');
        const tradeForm = document.getElementById('trade-form');
        const tradeTitle = document.getElementById('trade-modal-title');
        const tradeTickerEl = document.getElementById('trade-ticker');
        const tradeInfoEl = document.getElementById('trade-info');
        const tradeQtyInput = document.getElementById('trade-quantity');
        const tradePriceInput = document.getElementById('trade-price');
        const tradeFeeInput = document.getElementById('trade-fee');
        const tradeStatusEl = document.getElementById('trade-status');
        const tradeSubmitBtn = document.getElementById('trade-submit');
        const tradeCloseButtons = document.querySelectorAll('[data-close-trade]');
        const aiScanBtn = document.getElementById('ai-scan-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiContent = document.getElementById('ai-content');
        const realizedProfitEl = document.getElementById('realized-profit');
        const realizedCountEl = document.getElementById('realized-count');
        const refreshAllBtn = document.getElementById('refresh-all-btn');

        const QUOTE_ENDPOINT = '/api/quote/';
        let lastQuote = null;
        let lastCashRow = null;
        let tradeContext = null;
        let currentPortfolio = []; 

        if (lookupBtn) lookupBtn.addEventListener('click', handleLookup);
        if (positionForm) positionForm.addEventListener('submit', handlePositionSubmit);
        if (txnTypeSelect) txnTypeSelect.addEventListener('change', updateTransactionUI);
        if (tickerInput) tickerInput.addEventListener('change', maybePrefillDividendCurrency);
        if (tickerInput) tickerInput.addEventListener('blur', maybePrefillDividendCurrency);
        if (currencyInput) currencyInput.addEventListener('input', () => {
            currencyInput.value = currencyInput.value.toUpperCase();
        });
        if (cashAddBtn) cashAddBtn.addEventListener('click', () => handleCashAdjust('add'));
        if (cashRemoveBtn) cashRemoveBtn.addEventListener('click', () => handleCashAdjust('remove'));
        if (tradeForm) tradeForm.addEventListener('submit', handleTradeSubmit);
        
        tradeCloseButtons.forEach(btn => btn.addEventListener('click', closeTradeModal));
        document.addEventListener('click', handleTableAction);
        
        if (aiScanBtn) aiScanBtn.addEventListener('click', runPortfolioAiScan);
        if (refreshAllBtn) {
            refreshAllBtn.addEventListener('click', async () => {
                if (!ACTIVE_GROUP_ID) return;
                let loadingToast = null;
                try {
                    loadingToast = showToast('Verversen...', 'info', 0, true);

                    // 1) Koersen via JSON endpoint
                    const pricesResp = await fetch(`/api/groups/${ACTIVE_GROUP_ID}/refresh_prices`, { method: 'POST' });
                    const pricesJson = await pricesResp.json();
                    if (!pricesResp.ok) throw new Error(pricesJson.error || 'Koersen verversen mislukt');

                    // 2) Wisselkoersen: bepaal lijst munten
                    let currencies = [];
                    try {
                        const { data: currenciesRows, error: curErr2 } = await supabase
                            .from('Wisselkoersen')
                            .select('munt');
                        if (!curErr2 && currenciesRows) {
                            currencies = currenciesRows
                                .map(r => String(r.munt||'').toUpperCase())
                                .filter(c => c && c !== 'EUR');
                        }
                    } catch {}
                    if (!currencies.length && Array.isArray(currentPortfolio)) {
                        const set = new Set();
                        for (const row of currentPortfolio) {
                            const c = String(row.munt || row.currency || 'EUR').toUpperCase();
                            if (c && c !== 'EUR') set.add(c);
                        }
                        currencies = Array.from(set);
                    }

                    const wkResp = await fetch('/api/refresh-wk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ currencies })
                    });
                    const wkJson = await wkResp.json();
                    if (!wkResp.ok) throw new Error(wkJson.error || 'WK verversen mislukt');

                    // 3) UI updaten
                    await refreshAllFxRates();
                    await fetchPortfolio();
                    const msg = `${pricesJson.updated || pricesJson.message || 'koersen'} + ${wkJson.updated || 0} WK`;
                    showToast(`Verversen voltooid (${msg})`, 'success');
                } catch (e) {
                    console.error('Ververs klik fout:', e);
                    showToast(e.message || 'Verversen mislukt', 'error');
                } finally {
                    try { if (loadingToast && typeof loadingToast.close === 'function') loadingToast.close(); } catch {}
                }
            });
        }
        
        async function updateTotals() {
            const txnType = (txnTypeSelect?.value || 'BUY').toUpperCase();
            const qty = parseFloat(quantityInput?.value || '0') || 0;
            const price = parseFloat(quotePriceInput?.value || '0') || 0;
            const gross = qty * price;
            if (grossTotalInput) grossTotalInput.value = (isFinite(gross) ? gross.toFixed(2) : '0.00');
            const final = parseFloat(finalTotalInput?.value || '0') || 0;
            let derived = 0;
            if (final > 0) {
                derived = Math.abs(gross - final);
            }
            if (derivedCostInput) derivedCostInput.value = (isFinite(derived) ? derived.toFixed(2) : '0.00');
            const cur = (currencyInput?.value || lastQuote?.currency || 'EUR').trim().toUpperCase();
            const extra = document.getElementById('currency-extra');
            const eurInput = document.getElementById('final-total-eur');
            const wkOutput = document.getElementById('wk-output');
            const showExtra = cur !== 'EUR';
            if (extra) extra.classList.toggle('hidden', !showExtra);
            if (showExtra && eurInput && wkOutput) {
                const totalEur = parseFloat(eurInput.value || '0') || 0;
                if (totalEur > 0 && final > 0) {
                    const wk = final / totalEur; 
                    wkOutput.value = isFinite(wk) ? wk.toFixed(4) : '';
                } else {
                    try {
                        const rate = await fetchFxRate(cur);
                        if (rate && isFinite(rate)) {
                            wkOutput.value = Number(rate).toFixed(4);
                        } else {
                            wkOutput.value = '';
                        }
                    } catch { wkOutput.value = ''; }
                }
                const wkVal = parseFloat(wkOutput.value || '0') || 0;
                const kostenEigen = parseFloat(derivedCostInput?.value || '0') || 0;
                const feeEur = (wkVal > 0 ? (kostenEigen / wkVal) : 0);
                if (feeEurInput) feeEurInput.value = (isFinite(feeEur) ? feeEur.toFixed(2) : '0.00');
            } else if (wkOutput) {
                wkOutput.value = '';
                const feeEur = parseFloat(derivedCostInput?.value || '0') || 0;
                if (feeEurInput) feeEurInput.value = (isFinite(feeEur) ? feeEur.toFixed(2) : '0.00');
            }
        }
        [quantityInput, quotePriceInput, finalTotalInput, derivedCostInput, currencyInput, document.getElementById('final-total-eur')].forEach(el => {
            if (el) el.addEventListener('input', updateTotals);
        });
        if (quantityInput) updateTotals(); 

        async function fetchFxRate(cur) {
            const code = String(cur||'').toUpperCase();
            if (!code || code === 'EUR') return 1;
            try {
                const r1 = await fetch(`/api/wk/${encodeURIComponent(code)}`);
                const d1 = await r1.json();
                if (r1.ok && d1 && typeof d1.rate !== 'undefined') {
                    return Number(d1.rate) || null;
                }
                return null;
            } catch {
                return null;
            }
        }

        async function refreshAllFxRates() {
            try {
                const cache = new Map();
                const needed = new Set();
                if (Array.isArray(currentPortfolio)) {
                    for (const row of currentPortfolio) {
                        const c = String(row?.munt || row?.currency || 'EUR').toUpperCase();
                        if (c && c !== 'EUR') needed.add(c);
                    }
                }

                for (const c of needed) {
                    const rate = await fetchFxRate(c);
                    if (rate && isFinite(rate)) cache.set(c, Number(rate));
                }

                if (Array.isArray(currentPortfolio) && currentPortfolio.length > 0) {
                    const updated = [];
                    for (const row of currentPortfolio) {
                        const cur = String(row.munt || row.currency || 'EUR').toUpperCase();
                        if (!cur || cur === 'EUR') {
                            row.wisselkoers = 1;
                            updated.push(row);
                            continue;
                        }
                        const r = cache.get(cur);
                        if (r && isFinite(r)) row.wisselkoers = r;
                        updated.push(row);
                    }
                    currentPortfolio = updated;
                    renderDashboard(currentPortfolio);
                }
            } catch (e) {
                console.error('FX refresh error:', e);
                // Keep silent here; top-level toast already reports overall status
            }
        }

        async function loadDashboardSnapshot() {
            try {
                const resp = await fetch('/api/dashboard-snapshot');
                const data = await resp.json();
                if (!resp.ok) return;
                const wkMap = data.wk || {};
                if (Array.isArray(data.positions)) {
                    currentPortfolio = data.positions.map(p => {
                        const cur = String(p.munt || p.currency || 'EUR').toUpperCase();
                        const rate = typeof wkMap[cur] !== 'undefined' ? Number(wkMap[cur]) : (cur === 'EUR' ? 1 : undefined);
                        if (rate && isFinite(rate)) p.wisselkoers = rate;
                        return p;
                    });
                }
                if (typeof renderDashboard === 'function') {
                    renderDashboard(currentPortfolio || []);
                }
            } catch (e) {
                console.warn('Snapshot fetch fout', e);
            }
        }

        loadDashboardSnapshot();
        if (transactionDateInput) {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
            transactionDateInput.value = local;
        }

        function isCashRow(row) {
            return ((row && row.ticker) ? String(row.ticker) : '').toUpperCase() === 'CASH';
        }

        function findCashRow(rows) {
            if (!Array.isArray(rows)) return null;
            for (const r of rows) {
                if (isCashRow(r)) return r;
            }
            return null;
        }

        async function ensureRowCurrency(row) {
            try {
                const current = String(row.munt || row.currency || '').trim();
                if (current && current !== '-') return current.toUpperCase();
                const sym = String(row.ticker || '').toUpperCase();
                if (!sym) return current || '';
                const resp = await fetch(`/api/currency/${encodeURIComponent(sym)}`);
                const data = await resp.json();
                if (resp.ok && data.currency) {
                    row.munt = String(data.currency).toUpperCase();
                    return row.munt;
                }
                return current || '';
            } catch {
                return String(row.munt || row.currency || '').toUpperCase();
            }
        }

        async function resolveCurrenciesForPortfolio(rows) {
            if (!Array.isArray(rows)) return rows;
            const updated = [];
            for (const r of rows) {
                const cur = await ensureRowCurrency(r);
                if (cur) {
                    const rate = await fetchFxRate(cur);
                    if (rate && isFinite(rate)) r.wisselkoers = Number(rate);
                }
                updated.push(r);
            }
            return updated;
        }

        (async () => {
            try {
                if (Array.isArray(currentPortfolio) && currentPortfolio.length) {
                    const resolved = await resolveCurrenciesForPortfolio(currentPortfolio);
                    currentPortfolio = resolved;
                    if (typeof renderDashboard === 'function') renderDashboard(currentPortfolio);
                }
            } catch (e) {
                console.warn('Currency resolve error:', e);
            }
        })();

        function openAiModal(title) {
            if (document.getElementById('ai-modal-title')) {
                document.getElementById('ai-modal-title').textContent = title;
            }
            aiContent.innerHTML = '<div class="flex flex-col items-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-2"></div><p class="text-slate-400">AI is aan het nadenken...</p></div>';
            aiModal.classList.remove('hidden');
        }

        function closeAiModal() {
            aiModal.classList.add('hidden');
        }

        async function analyzeStock(ticker) {
            openAiModal(`Analyseer ${ticker}`);
            try {
                const response = await fetch('/api/ai/analyze-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                aiContent.innerHTML = data.analysis; 
            } catch (err) {
                aiContent.innerHTML = `<p class="text-red-500">Fout bij analyse: ${err.message}</p>`;
            }
        }

        async function runPortfolioAiScan() {
            if (!currentPortfolio || currentPortfolio.length === 0) {
                alert("Geen posities om te analyseren.");
                return;
            }
            
            const positions = currentPortfolio
                .filter(p => p.ticker !== 'CASH')
                .map(p => ({
                    ticker: p.ticker,
                    quantity: p.quantity,
                    value: (p.quantity * p.current_price).toFixed(2)
                }));

            openAiModal("Portefeuille Scan");
            
            try {
                const response = await fetch('/api/ai/analyze-portfolio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions: positions })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                aiContent.innerHTML = data.analysis;
            } catch (err) {
                aiContent.innerHTML = `<p class="text-red-500">Fout bij analyse: ${err.message}</p>`;
            }
        }

        function updateTransactionUI() {
            const t = (txnTypeSelect?.value || 'BUY').toUpperCase();
            const labelMap = { 'BUY': 'Aankoop', 'SELL': 'Verkoop', 'DIVIDEND': 'Dividend', 'TRANSFER': 'Overschrijving', 'PAYOUT': 'Uitbetaling effecten' };
            if (t === 'BUY' || t === 'SELL' || t === 'DIVIDEND') {
                buySection?.classList.remove('hidden');
                txnPlaceholder?.classList.add('hidden');
                if (positionSubmitBtn) positionSubmitBtn.disabled = false;
                if (t === 'DIVIDEND') {
                    setFormStatus('Dividend: vul ticker en velden in', 'info');
                    // Verberg Yahoo-lookup voor dividend
                    if (lookupBtn) lookupBtn.classList.add('hidden');
                    // Prefill munt/wk vanuit transacties
                    maybePrefillDividendCurrency();
                } else {
                    setFormStatus(t === 'BUY' ? 'Zoek een ticker om details te laden' : 'Verkoop: vul ticker/velden in', 'info');
                    if (lookupBtn) lookupBtn.classList.remove('hidden');
                }
                const costLabel = document.getElementById('cost-label');
                const totalLabel = document.getElementById('total-label');
                if (costLabel) costLabel.textContent = (t === 'SELL') ? 'Kosten (Bruto − TOTAAL)' : (t === 'DIVIDEND' ? 'Afwijking (optioneel)' : 'Kosten (TOTAAL − Bruto)');
                if (totalLabel) totalLabel.textContent = (t === 'SELL') ? 'Totaal (netto) in beursvaluta' : 'Totaal in beursvaluta';

                // Verberg het Sector-veld bij Dividend
                try {
                    const sectorContainer = quoteSectorEl ? quoteSectorEl.closest('div') : null;
                    if (sectorContainer) sectorContainer.classList.toggle('hidden', t === 'DIVIDEND');
                } catch {}
                try { updateTotals(); } catch {}
            } else {
                buySection?.classList.add('hidden');
                if (txnPlaceholder) {
                    txnPlaceholder.textContent = `Velden voor "${labelMap[t] || t}" komen hier.`;
                    txnPlaceholder.classList.remove('hidden');
                }
                if (positionSubmitBtn) positionSubmitBtn.disabled = true;
                setFormStatus('Dit transactietype volgt later.', 'info');
            }
        }
        updateTransactionUI();

        async function maybePrefillDividendCurrency() {
            const t = (txnTypeSelect?.value || 'BUY').toUpperCase();
            if (t !== 'DIVIDEND') return;
            const sym = (tickerInput?.value || '').trim().toUpperCase();
            if (!sym) return;
            try {
                const { data, error } = await supabase
                    .from('Transacties')
                    .select('munt,wisselkoers')
                    .eq('ticker', sym)
                    .order('datum_tr', { ascending: false })
                    .limit(1);
                if (!error && data && data[0]) {
                    const cur = String(data[0].munt || 'EUR').toUpperCase();
                    const wk = Number(data[0].wisselkoers) || (cur === 'EUR' ? 1 : undefined);
                    if (currencyInput && cur) currencyInput.value = cur;
                    const wkOutput = document.getElementById('wk-output');
                    if (wkOutput && wk) wkOutput.value = String(wk);
                    try { updateTotals(); } catch {}
                }
            } catch {}
        }

        async function fetchPortfolio() {
            try {
                if (!ACTIVE_GROUP_ID) {
                    resetDashboard();
                    return;
                }

                const { data, error } = await supabase
                    .from('Portefeuille')
                    .select('*')
                    .eq('groep_id', ACTIVE_GROUP_ID);

                if (error) throw error;

                if (!data || data.length === 0) {
                    await ensureCashRow();
                    return fetchPortfolio();
                }

                const hasCash = data.some(isCashRow);
                if (!hasCash) {
                    await ensureCashRow();
                    return fetchPortfolio();
                }

                const enriched = await augmentPortfolioCurrencies(data);
                const withQuoteCurrencies = await augmentWithQuoteCurrencies(enriched);
                currentPortfolio = withQuoteCurrencies;
                renderDashboard(currentPortfolio);
                fetchRealizedProfit();
            } catch (err) {
                console.error("Error:", err);
                const et = document.getElementById('error-text');
                if (et) et.innerText = err.message || String(err);
                const em = document.getElementById('error-message');
                if (em) em.classList.remove('hidden');
            }
        }

        async function augmentPortfolioCurrencies(rows) {
            if (!Array.isArray(rows) || rows.length === 0) return rows;
            const result = [];
            for (const row of rows) {
                const t = String(row.ticker||'').toUpperCase();
                if (t === 'CASH') { result.push(row); continue; }
                try {
                    const { data: txs, error } = await supabase
                        .from('Transacties')
                        .select('munt,wisselkoers,ticker')
                        .eq('ticker', String(row.ticker||'').toUpperCase())
                        .order('datum_tr', { ascending: false })
                        .limit(1);
                    if (!error && txs && txs.length > 0) {
                        const tx = txs[0];
                        const existingCur = String(row.munt || '').toUpperCase();
                        const txCur = String(tx.munt || '').toUpperCase();
                        const wk = (typeof tx.wisselkoers !== 'undefined' && tx.wisselkoers !== null) ? Number(tx.wisselkoers) : (existingCur==='EUR' ? 1 : undefined);
                        if (!existingCur && txCur) row.munt = txCur;
                        if (!isNaN(wk)) row.wisselkoers = wk;
                    }
                } catch (e) {}
                result.push(row);
            }
            return result;
        }

        async function augmentWithQuoteCurrencies(rows) {
            if (!Array.isArray(rows) || rows.length === 0) return rows;
            const result = [];
            const cache = new Map();
            for (const row of rows) {
                const t = String(row.ticker||'').toUpperCase();
                if (t === 'CASH') { result.push(row); continue; }
                try {
                    let q = cache.get(t);
                    if (!q) {
                        const resp = await fetch(`${QUOTE_ENDPOINT}${encodeURIComponent(t)}`);
                        q = await resp.json();
                        cache.set(t, q);
                    }
                    const dbCur = String(row.munt || '').toUpperCase();
                    if (dbCur) {
                        if (dbCur === 'EUR') {
                            row.wisselkoers = 1;
                        } else {
                            const fx = await fetchFxRate(dbCur);
                            if (fx && isFinite(fx)) row.wisselkoers = Number(fx);
                        }
                    }
                } catch {}
                result.push(row);
            }
            return result;
        }
        async function fetchRealizedProfit() {
            try {
                if (!ACTIVE_GROUP_ID || !realizedProfitEl) return;
                const resp = await fetch(`/api/groups/${ACTIVE_GROUP_ID}/realized_profit`);
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Kon gerealiseerde winst niet ophalen');
                const total = Number(data.total || 0);
                realizedProfitEl.textContent = eur.format(total);
                realizedProfitEl.className = 'text-3xl font-bold ' + (total >= 0 ? 'text-emerald-600' : 'text-rose-600');
                if (realizedCountEl) realizedCountEl.textContent = 'inclusief dividenden';
            } catch (e) {
                if (realizedProfitEl) realizedProfitEl.textContent = '€ 0,00';
            }
        }

        function resetDashboard() {
            document.getElementById('total-value').innerText = "€ 0,00";
            document.getElementById('total-gain').innerText = "€ 0,00";
            document.getElementById('position-count').innerText = '0';
            document.getElementById('gain-percent').innerText = '0%';
            document.getElementById('portfolio-table-body').innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-400">Selecteer een groep om posities te laden.</td></tr>';
            updateChart({});
            clearQuoteSummary();
            setFormStatus(ACTIVE_GROUP_ID ? 'Zoek een ticker om details te laden' : 'Selecteer eerst een groep', 'info');
            lastCashRow = null;
            setCashControlsState(false);
            updateCashCard(0);
        }

        function renderDashboard(portfolio) {
            const cashRow = findCashRow(portfolio);
            lastCashRow = cashRow;
            const cashAmount = cashRow ? Number(cashRow.current_price) || 0 : 0;
            const positions = portfolio.filter(row => !isCashRow(row) && (Number(row.quantity) || 0) > 0);

            setCashControlsState(true);

            let totalVal = 0;
            let totalCost = 0;
            let sectorTotals = {};

            const tbody = document.getElementById('portfolio-table-body');
            tbody.innerHTML = '';

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-6 text-center text-slate-400">Geen aandelen gevonden in portefeuille.</td></tr>';
            }

            positions.forEach(item => {
                const qty = item.quantity || 0;
                const price = item.current_price || 0;
                const avg = item.current_price || item.avg_price || 0; 
                const fee = Number(item.transactiekost) || 0;
                const val = qty * price;
                const cost = qty * avg + fee; 
                const gain = val - cost;
                const rowId = item.port_id ?? item.id ?? item.ID ?? item.portefeuille_id ?? '';
                
                const sectorName = item.sector ? item.sector : "Overig";
                
                if (sectorTotals[sectorName]) {
                    sectorTotals[sectorName] += val;
                } else {
                    sectorTotals[sectorName] = val;
                }

                totalVal += val;
                totalCost += cost;

                const attrTicker = escapeAttr(item.ticker || '');
                const attrName = escapeAttr(item.name || '');
                const row = `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 font-bold text-slate-900">
                            ${item.ticker}
                            <div class="text-xs text-slate-400 font-normal">${item.name || ''}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-600">
                            <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-medium">
                                ${sectorName}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-600">${(function(){
                            const t = String(item.ticker||'').toUpperCase();
                            if (t === 'CASH') return 'EUR';
                            const cur = String(item.munt || item.currency || '').toUpperCase();
                            if (cur) return cur;
                            return '—';
                        })()}</td>
                        <td class="px-6 py-4 text-right text-slate-600 font-medium">${qty}</td>
                        <td class="px-6 py-4 text-right text-slate-600">${eur.format(price)}</td>
                        <td class="px-6 py-4 text-right text-slate-600">${(function(){
                            const wk = Number(item.wisselkoers);
                            const cur = String(item.munt||item.currency||'').toUpperCase();
                            if (cur === 'EUR') return '1.0000';
                            if (!isNaN(wk) && wk > 0) return wk.toFixed(4);
                            return '—';
                        })()}</td>
                        <td class="px-6 py-4 text-right text-slate-600">${(function(){
                            const wk = Number(item.wisselkoers);
                            const cur = String(item.munt||item.currency||'').toUpperCase();
                            if (cur === 'EUR') return eur.format(price);
                            if (!isNaN(wk) && wk > 0) return eur.format(price / wk);
                            return '—';
                        })()}</td>
                        <td class="px-6 py-4 text-right font-bold text-slate-900">${eur.format(val)}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="${gain >= 0 ? 'text-emerald-600' : 'text-rose-600'} font-bold">
                                ${eur.format(gain)}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button type="button" class="p-1.5 rounded-lg text-purple-600 hover:bg-purple-50 ai-analyze-stock" data-ticker="${attrTicker}" title="AI Analyse">
                                    <i data-lucide="bot" class="h-5 w-5"></i>
                                </button>
                                <a
                                    class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-semibold hover:bg-slate-200"
                                    href="/transactions?port_id=${rowId}"
                                    title="Bekijk transacties">
                                    Transacties
                                </a>
                                
                                ${ IS_HOST ? `
                                <button type="button"
                                    class="buy-position px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 text-xs font-semibold hover:bg-emerald-100"
                                    data-position-id="${rowId}"
                                    data-ticker="${attrTicker}"
                                    data-name="${attrName}"
                                    data-quantity="${qty}"
                                    data-avg-price="${avg}"
                                    data-price="${price}"
                                    data-fee="${fee}">
                                    Kopen
                                </button>
                                <button type="button"
                                    class="sell-position px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 text-xs font-semibold hover:bg-rose-100"
                                    data-position-id="${rowId}"
                                    data-ticker="${attrTicker}"
                                    data-name="${attrName}"
                                    data-quantity="${qty}"
                                    data-avg-price="${avg}"
                                    data-price="${price}"
                                    data-fee="${fee}">
                                    Verkopen
                                </button>
                                ` : '' }
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            lucide.createIcons();

            const totalGain = totalVal - totalCost;
            const gainPct = totalCost > 0 ? (totalGain / totalCost) * 100 : 0;

            const overallValue = totalVal + cashAmount;
            document.getElementById('total-value').innerText = eur.format(overallValue);
            document.getElementById('total-gain').innerText = eur.format(totalGain);
            document.getElementById('position-count').innerText = positions.length;
            document.getElementById('gain-percent').innerText = (totalGain >= 0 ? '+' : '') + gainPct.toFixed(2) + '%';

            updateCashCard(cashAmount);

            const gainEl = document.getElementById('total-gain');
            const badgeEl = document.getElementById('gain-badge');
            
            if (totalGain >= 0) {
                gainEl.className = "text-3xl font-bold text-emerald-600";
                badgeEl.className = "mt-4 inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold bg-emerald-100 text-emerald-700";
            } else {
                gainEl.className = "text-3xl font-bold text-rose-600";
                badgeEl.className = "mt-4 inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold bg-rose-100 text-rose-700";
            }

            updateChart(sectorTotals);
        }

        let myChart = null;

        function escapeAttr(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function updateChart(dataObj) {
            const ctx = document.getElementById('sectorChart').getContext('2d');
            
            if (myChart) myChart.destroy();

            const labels = Object.keys(dataObj);
            const dataValues = Object.values(dataObj);

            const colors = [
                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#64748b'
            ];

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, padding: 20, boxWidth: 8 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(context.parsed);
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '75%'
                }
            });
        }

        function setFormStatus(message, type = 'info') {
            if (!formStatusEl) return;
            const colors = {
                info: 'text-slate-500',
                success: 'text-emerald-600',
                error: 'text-rose-600'
            };
            formStatusEl.textContent = message;
            formStatusEl.className = 'quote-pill ' + (colors[type] || colors.info);
        }

        // Global toast helper (fixed position). Returns { close() }.
        // durationMs: 0 => sticky until close(); default 2000ms.
        // spinning: when true, shows a rotating refresh icon.
        function showToast(message, type = 'info', durationMs = 2000, spinning = false) {
            const root = document.getElementById('toast-root');
            if (!root) return;
            const palette = {
                info:  { bg: 'bg-slate-900', text: 'text-white', icon: 'info' },
                success:{ bg: 'bg-emerald-600', text: 'text-white', icon: 'check-circle' },
                error: { bg: 'bg-rose-600', text: 'text-white', icon: 'alert-triangle' }
            };
            const p = palette[type] || palette.info;
            const el = document.createElement('div');
            el.className = `${p.bg} ${p.text} shadow-xl rounded-lg px-4 py-3 flex items-center gap-2 transform transition-all duration-300 pointer-events-auto`;
            el.style.opacity = '0';
            el.style.translate = '0 4px';
            const icon = spinning ? 'refresh-cw' : p.icon;
            const spinClass = spinning ? 'animate-spin' : '';
            el.innerHTML = `<i data-lucide="${icon}" class="h-4 w-4 ${spinClass}"></i><span class="text-sm font-medium">${message}</span>`;
            root.appendChild(el);
            lucide.createIcons({ attrs: { class: 'h-4 w-4' } });
            requestAnimationFrame(() => {
                el.style.opacity = '1';
                el.style.translate = '0 0';
            });
            const hide = () => {
                el.style.opacity = '0';
                el.style.translate = '0 4px';
                setTimeout(() => el.remove(), 250);
            };
            if (durationMs && durationMs > 0) {
                setTimeout(hide, durationMs);
            }
            return { close: hide };
        }

        function updateQuoteSummary(quote) {
            if (!quoteNameEl || !quotePriceInput || !quoteSectorEl) return;
            quoteNameEl.textContent = quote.longName || quote.shortName || quote.symbol || '—';
            quoteSectorEl.textContent = quote.sector || 'Onbekend';
            const rawPrice = quote.regularMarketPrice || quote.postMarketPrice || null;
            if (rawPrice != null) {
                quotePriceInput.value = rawPrice.toFixed(2);
            }
            if (currencyInput) {
                const qcur = (quote.currency || '').toUpperCase();
                if (qcur) {
                    currencyInput.value = qcur;
                } else if (!currencyInput.value) {
                    currencyInput.value = 'EUR';
                }
            }
        }

        function clearQuoteSummary() {
            if (quoteNameEl) quoteNameEl.textContent = '—';
            if (quoteSectorEl) quoteSectorEl.textContent = '—';
            if (quotePriceInput) quotePriceInput.value = '';
            lastQuote = null;
        }

        async function handleLookup() {
            if (!ACTIVE_GROUP_ID) {
                setFormStatus('Selecteer eerst een groep', 'error');
                return;
            }
            if (!tickerInput || !tickerInput.value.trim()) {
                setFormStatus('Vul een ticker in', 'error');
                return;
            }
            const symbol = tickerInput.value.trim().toUpperCase();
            setFormStatus(`Zoeken naar ${symbol}...`, 'info');
            try {
                const quote = await fetchQuote(symbol);
                lastQuote = quote;
                updateQuoteSummary(quote);
                setFormStatus('Quote geladen. Vul aantallen in en sla op.', 'success');
            } catch (err) {
                clearQuoteSummary();
                setFormStatus(err.message || 'Ticker niet gevonden', 'error');
            }
        }

        async function fetchQuote(symbol) {
            const response = await fetch(`${QUOTE_ENDPOINT}${encodeURIComponent(symbol)}`);
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server error: Route niet gevonden of server crash (HTML ontvangen).");
            }

            const payload = await response.json();
            if (!response.ok) {
                throw new Error(payload?.error || 'Quote niet beschikbaar');
            }
            return payload;
        }
    
        
        async function handlePositionSubmit(event) {
            event.preventDefault();
            const t = (txnTypeSelect?.value || 'BUY').toUpperCase();
            if (t !== 'BUY' && t !== 'SELL' && t !== 'DIVIDEND') {
                setFormStatus('Dit transactietype is nog niet actief.', 'info');
                return;
            }
            if (!ACTIVE_GROUP_ID) {
                setFormStatus('Selecteer eerst een groep', 'error');
                return;
            }
            if (!tickerInput || !quantityInput) {
                setFormStatus('Formulier niet volledig geladen', 'error');
                return;
            }
            const symbol = (tickerInput.value || '').trim().toUpperCase();
            const qty = parseFloat(quantityInput.value || '0');
            let overridePrice = parseFloat(quotePriceInput?.value || '0');
            let tradePrice = (overridePrice && overridePrice > 0) ? overridePrice : (lastQuote?.regularMarketPrice || 0);
            let transactionCost = parseFloat((document.getElementById('fee-local')?.value) || derivedCostInput?.value || '0');
            const grossFromInputs = (qty * tradePrice);
            const finalProvided = parseFloat(finalTotalInput?.value || '0');
            if (finalTotalInput && finalProvided > 0) {
                if (t === 'BUY') {
                    transactionCost = finalProvided - (qty * tradePrice);
                } else if (t === 'SELL') {
                    transactionCost = (qty * tradePrice) - finalProvided;
                } else {
                    // DIVIDEND: geen kostenvergelijking; laat afwijking ongemoeid
                }
            }
            let selectedCurrency = (currencyInput?.value || lastQuote?.currency || 'EUR').trim().toUpperCase();
            if (!selectedCurrency.match(/^[A-Z]{2,6}$/)) {
                setFormStatus('Ongeldige munt (2–6 letters)', 'error');
                return;
            }

            if (!symbol) {
                setFormStatus('Geef een ticker op', 'error');
                return;
            }
            if (symbol === 'CASH') {
                setFormStatus('Ticker CASH is gereserveerd voor het kassaldo.', 'error');
                return;
            }
            if (!qty || qty <= 0) {
                setFormStatus('Aantal moet groter dan 0 zijn', 'error');
                return;
            }
            if (t !== 'DIVIDEND') {
                if (!tradePrice || tradePrice <= 0) {
                    setFormStatus('Laad eerst een koers (Zoek).', 'error');
                    return;
                }
            }
            if (isNaN(transactionCost)) {
                transactionCost = 0;
            }
            if (transactionCost < 0) {
                setFormStatus('Kosten mogen niet kleiner dan 0 zijn', 'error');
                return;
            }

            if (!lastCashRow) {
                setFormStatus('Cashpositie niet gevonden', 'error');
                return;
            }

            const feeAmount = transactionCost; 
            const wkVal = (parseFloat(document.getElementById('wk-output')?.value || '0') || 1);
            const isEur = (selectedCurrency === 'EUR');
            const feeAmountEur = isEur ? feeAmount : (wkVal > 0 ? (feeAmount / wkVal) : 0);
            const grossLocal = qty * tradePrice; 
            const cashAvailable = Number(lastCashRow.current_price) || 0; 
            const priceEur = isEur ? tradePrice : (wkVal > 0 ? (tradePrice / wkVal) : NaN);
            let totalEur = NaN;
            if (t === 'BUY') {
                const totalCostLocal = grossLocal + feeAmount; 
                totalEur = isEur ? totalCostLocal : (wkVal > 0 ? (totalCostLocal / wkVal) : NaN);
                if (!isFinite(totalEur) || totalEur <= 0) {
                    setFormStatus('Ongeldige wisselkoers of totaalbedrag.', 'error');
                    return;
                }
                if (totalEur > cashAvailable + 1e-8) {
                    setFormStatus('Niet genoeg cash voor deze transactie.', 'error');
                    return;
                }
            } else if (t === 'SELL') {
                const totalProceedsLocal = grossLocal - feeAmount;
                totalEur = isEur ? totalProceedsLocal : (wkVal > 0 ? (totalProceedsLocal / wkVal) : NaN);
                if (!isFinite(totalEur) || totalEur < 0) {
                    setFormStatus('Ongeldige wisselkoers of totaalbedrag.', 'error');
                    return;
                }
            } else if (t === 'DIVIDEND') {
                // Dividend: gebruik opgegeven totalen; fallback naar qty*price als totaal ontbreekt
                const eurInput = document.getElementById('final-total-eur');
                const totalLocalInputVal = parseFloat(finalTotalInput?.value || '0') || 0;
                const totalEurInputVal = parseFloat(eurInput?.value || '0') || 0;
                if (totalEurInputVal > 0) {
                    totalEur = totalEurInputVal;
                } else if (totalLocalInputVal > 0) {
                    totalEur = isEur ? totalLocalInputVal : (wkVal > 0 ? (totalLocalInputVal / wkVal) : NaN);
                } else {
                    totalEur = isEur ? grossLocal : (wkVal > 0 ? (grossLocal / wkVal) : NaN);
                }
                if (!isFinite(totalEur) || totalEur < 0) {
                    setFormStatus('Ongeldige wisselkoers of totaalbedrag.', 'error');
                    return;
                }
                // Koers afleiden uit het totaal zodat Waarde(€) precies gelijk is aan Totaal in euro
                if (qty > 0) {
                    const localTotal = isEur ? totalEur : (wkVal > 0 ? (totalEur * wkVal) : 0);
                    tradePrice = (localTotal / qty);
                }
            }

            const dateStr = (transactionDateInput?.value || '').trim() || '—';
            const summary = [
                `Transactietype: ${t === 'BUY' ? 'Aankoop' : (t === 'SELL' ? 'Verkoop' : 'Dividend')}`,
                `Ticker: ${symbol}`,
                `Aantal: ${qty}`,
                `Koers: ${tradePrice.toFixed(2)} ${selectedCurrency}`,
                `Bruto: ${grossLocal.toFixed(2)} ${selectedCurrency}`,
                `${t==='DIVIDEND' ? '' : `Kosten (eigen munt): ${feeAmount.toFixed(2)} ${selectedCurrency}`}`,
                `${t==='BUY' ? 'Totaal (eigen munt)' : (t==='SELL' ? 'Netto (eigen munt)' : 'Totaal (eigen munt)')}: ${(t==='BUY' ? (grossLocal+feeAmount) : (t==='SELL' ? (grossLocal-feeAmount) : grossLocal)).toFixed(2)} ${selectedCurrency}`,
                `Totaal (EUR): ${totalEur.toFixed(2)} EUR`,
                `Transactiedatum: ${dateStr}`
            ].join('\n');
            const confirmMsg = `${summary}\n\nBen je zeker dat je deze transactie wil opslaan?`;
            const ok = window.confirm(confirmMsg);
            if (!ok) {
                setFormStatus('Opslaan geannuleerd', 'info');
                return;
            }

            const priceNow = tradePrice; 
            const positionName = lastQuote?.longName || lastQuote?.shortName || symbol;
            const sector = lastQuote?.sector || 'Onbekend';

            setFormStatus('Opslaan...', 'info');
            const { data: existingRows, error: existErr } = await supabase
                .from('Portefeuille')
                .select('port_id, quantity, avg_price, transactiekost')
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', symbol)
                .limit(1);
            if (existErr) {
                setFormStatus(existErr.message || 'Controle op bestaande positie mislukt', 'error');
                return;
            }

            let insertedPortId = null;
            if (t === 'DIVIDEND') {
                if (!existingRows || existingRows.length === 0) {
                    setFormStatus('Geen bestaande positie voor dit dividend.', 'error');
                    return;
                }
                insertedPortId = existingRows[0].port_id;
            } else if (t === 'BUY' && existingRows && existingRows.length > 0) {
                const existing = existingRows[0];
                const prevQty = Number(existing.quantity) || 0;
                const prevAvg = Number(existing.avg_price) || 0;
                const prevFee = Number(existing.transactiekost) || 0;
                const newQty = prevQty + qty;
                if (newQty <= 0) {
                    setFormStatus('Aantal moet groter dan 0 zijn', 'error');
                    return;
                }
                const newAvg = ((prevQty * prevAvg) + (qty * priceEur)) / newQty;
                const newFee = prevFee + feeAmountEur;

                const { error: updError } = await supabase
                    .from('Portefeuille')
                    .update({
                        quantity: newQty,
                        avg_price: newAvg,
                        current_price: priceNow,
                        sector: sector,
                        name: positionName,
                        transactiekost: newFee
                    })
                    .eq('groep_id', ACTIVE_GROUP_ID)
                    .eq('port_id', existing.port_id);
                if (updError) {
                    setFormStatus(updError.message || 'Bijwerken bestaande positie mislukt', 'error');
                    return;
                }
                insertedPortId = existing.port_id;
            } else if (t === 'BUY') {
                const payload = {
                    groep_id: ACTIVE_GROUP_ID,
                    ticker: symbol,
                    name: positionName,
                    quantity: qty,
                    avg_price: priceEur,
                    current_price: priceNow,
                    sector: sector,
                    transactiekost: feeAmountEur
                };
                const { data: insertData, error } = await supabase.from('Portefeuille').insert([payload]).select();
                if (error) {
                    setFormStatus(error.message || 'Opslaan mislukt', 'error');
                    return;
                }
                insertedPortId = insertData?.[0]?.port_id || insertData?.[0]?.id || null;
            } else if (t === 'SELL') {
                if (!existingRows || existingRows.length === 0) {
                    setFormStatus('Geen bestaande positie om te verkopen', 'error');
                    return;
                }
                const existing = existingRows[0];
                const prevQty = Number(existing.quantity) || 0;
                if (qty > prevQty) {
                    setFormStatus('Niet genoeg aandelen om te verkopen.', 'error');
                    return;
                }
                const newQty = prevQty - qty;
                const prevFee = Number(existing.transactiekost) || 0;
                const newFee = prevFee + feeAmount;
                const { error: updSellErr } = await supabase
                    .from('Portefeuille')
                    .update({
                        quantity: newQty,
                        current_price: priceNow,
                        transactiekost: newFee
                    })
                    .eq('groep_id', ACTIVE_GROUP_ID)
                    .eq('port_id', existing.port_id);
                if (updSellErr) {
                    setFormStatus(updSellErr.message || 'Bijwerken positie (verkoop) mislukt', 'error');
                    return;
                }
                insertedPortId = existing.port_id;
            }

            const nextCash = t === 'BUY' ? (cashAvailable - totalEur) : (cashAvailable + totalEur);
            const cashUpdateOk = await updateCashBalance(nextCash);
            if (!cashUpdateOk) {
                if (existingRows && existingRows.length > 0) {
                    const existing = existingRows[0];
                    await supabase
                        .from('Portefeuille')
                        .update({
                            quantity: existing.quantity,
                            avg_price: existing.avg_price,
                            current_price: priceNow,
                            transactiekost: existing.transactiekost
                        })
                        .eq('groep_id', ACTIVE_GROUP_ID)
                        .eq('port_id', existing.port_id);
                } else if (insertedPortId) {
                    await supabase
                        .from('Portefeuille')
                        .delete()
                        .eq('groep_id', ACTIVE_GROUP_ID)
                        .eq('port_id', insertedPortId);
                }
                setFormStatus('Cash bijwerken mislukt. Probeer opnieuw.', 'error');
                return;
            }

            if (lastCashRow) lastCashRow.current_price = nextCash;
            try {
                await fetch('/api/transactions/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: t,
                        ticker: symbol,
                        aantal: qty,
                        koers: priceNow,
                        wisselkoers: (parseFloat(document.getElementById('wk-output')?.value || '0') || 1),
                        munt: selectedCurrency,
                        datum_tr: (transactionDateInput?.value || null),
                        portefeuille_id: insertedPortId
                    })
                });
                if ((t === 'BUY' || t === 'SELL') && feeAmount && feeAmount > 0) {
                    await fetch('/api/transactions/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'FEE',
                            ticker: symbol,
                            aantal: 1,
                            koers: feeAmount,
                            wisselkoers: (parseFloat(document.getElementById('wk-output')?.value || '0') || 1),
                            munt: selectedCurrency,
                            datum_tr: (transactionDateInput?.value || null),
                            portefeuille_id: insertedPortId
                        })
                    });
                }
            } catch (e) {
                console.warn('Log initiële aankoop mislukt', e);
            }
            setFormStatus(t === 'BUY' ? 'Aankoop opgeslagen' : (t === 'SELL' ? 'Verkoop opgeslagen' : 'Dividend opgeslagen'), 'success');
            if (positionForm) positionForm.reset();
            clearQuoteSummary();
            fetchPortfolio();
        }

        async function updateCashBalance(nextAmount) {
            const { error } = await supabase
                .from('Portefeuille')
                .update({ current_price: nextAmount })
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', 'CASH');
            if (error) {
                console.error('Cash update mislukt', error);
                return false;
            }
            return true;
        }

        function handleTableAction(event) {
            const aiBtn = event.target.closest('.ai-analyze-stock');
            if (aiBtn) {
                event.preventDefault();
                const ticker = aiBtn.dataset.ticker;
                if (ticker) analyzeStock(ticker);
                return;
            }

            if (!ACTIVE_GROUP_ID) return;
            const buyBtn = event.target.closest('.buy-position');
            if (buyBtn) {
                event.preventDefault();
                openTradeModal('buy', buyBtn.dataset);
                return;
            }
            const sellBtn = event.target.closest('.sell-position');
            if (sellBtn) {
                event.preventDefault();
                openTradeModal('sell', sellBtn.dataset);
            }
        }

        function openTradeModal(mode, dataset) {
            if (!tradeModal) return;
            tradeContext = {
                mode,
                positionId: dataset.positionId || '',
                ticker: dataset.ticker || '',
                quantity: Number(dataset.quantity) || 0,
                avgPrice: Number(dataset.avgPrice) || 0,
                price: Number(dataset.price) || 0,
                fee: Number(dataset.fee) || 0
            };
            if (tradeTitle) {
                tradeTitle.textContent = mode === 'buy' ? `Kopen ${tradeContext.ticker}` : `Verkopen ${tradeContext.ticker}`;
            }
            if (tradeTickerEl) {
                tradeTickerEl.textContent = tradeContext.ticker || '—';
            }
            if (tradeInfoEl) {
                tradeInfoEl.textContent = mode === 'buy'
                    ? `Beschikbare cash: ${eur.format(Number(lastCashRow?.current_price) || 0)}`
                    : `Beschikbare aandelen: ${tradeContext.quantity}`;
            }
            if (tradeQtyInput) tradeQtyInput.value = '';
            if (tradePriceInput) tradePriceInput.value = tradeContext.price || '';
            if (tradeFeeInput) tradeFeeInput.value = transactionCostInput?.value || '';
            if (tradeSubmitBtn) {
                tradeSubmitBtn.textContent = mode === 'buy' ? 'Koop bevestigen' : 'Verkoop bevestigen';
            }
            setTradeStatus('Vul de velden in en bevestig.', 'info');
            tradeModal.classList.remove('hidden');
        }

        function closeTradeModal() {
            if (!tradeModal) return;
            tradeModal.classList.add('hidden');
            tradeContext = null;
        }

        function setTradeStatus(message, type = 'info') {
            if (!tradeStatusEl) return;
            const colors = {
                info: 'text-slate-400',
                success: 'text-emerald-600',
                error: 'text-rose-600'
            };
            tradeStatusEl.textContent = message;
            tradeStatusEl.className = 'text-xs ' + (colors[type] || colors.info);
        }

        function applyPositionFilter(query) {
            if (tradeContext?.positionId) {
                return query.eq('port_id', tradeContext.positionId);
            }
            return query.eq('ticker', tradeContext?.ticker || '');
        }

        async function handleTradeSubmit(event) {
            event.preventDefault();
            if (!tradeContext) {
                setTradeStatus('Geen positie geselecteerd', 'error');
                return;
            }
            if (!tradeContext.positionId && !tradeContext.ticker) {
                setTradeStatus('Kon positie niet laden', 'error');
                return;
            }
            const qty = parseFloat(tradeQtyInput?.value || '0');
            const price = parseFloat(tradePriceInput?.value || '0');
            let fee = parseFloat(tradeFeeInput?.value || '0');
            if (!qty || qty <= 0) {
                setTradeStatus('Aantal moet groter dan 0 zijn', 'error');
                return;
            }
            if (!price || price <= 0) {
                setTradeStatus('Prijs moet groter dan 0 zijn', 'error');
                return;
            }
            if (isNaN(fee) || fee < 0) {
                fee = 0;
            }
            setTradeStatus('Transactie verwerken...', 'info');
            try {
                if (tradeContext.mode === 'buy') {
                    await processBuy(qty, price, fee);
                } else {
                    await processSell(qty, price, fee);
                }
                setTradeStatus('Transactie voltooid', 'success');
                setTimeout(() => {
                    closeTradeModal();
                    fetchPortfolio();
                }, 600);
            } catch (err) {
                console.error('Transactie mislukt', err);
                setTradeStatus(err.message || 'Transactie mislukt', 'error');
            }
        }

        async function processBuy(qty, price, fee) {
            if (!lastCashRow) {
                throw new Error('Cashpositie niet gevonden');
            }
            const cashAvailable = Number(lastCashRow.current_price) || 0;
            const totalCost = qty * price + fee;
            if (cashAvailable < totalCost) {
                throw new Error('Niet genoeg cash voor deze transactie.');
            }
            const currentQty = Number(tradeContext.quantity) || 0;
            const currentAvg = Number(tradeContext.avgPrice) || 0;
            const currentFee = Number(tradeContext.fee) || 0;
            const newQty = currentQty + qty;
            const newAvg = newQty > 0 ? (((currentQty * currentAvg) + (qty * price)) / newQty) : price;
            const newFeeTotal = currentFee + fee;

            const { error: positionError } = await applyPositionFilter(
                supabase
                    .from('Portefeuille')
                    .update({
                        quantity: newQty,
                        avg_price: newAvg,
                        current_price: price,
                        transactiekost: newFeeTotal
                    })
                    .eq('groep_id', ACTIVE_GROUP_ID)
            );

            if (positionError) {
                throw new Error(positionError.message || 'Positie bijwerken mislukt');
            }

            const newCash = cashAvailable - totalCost;
            const { error: cashError } = await supabase
                .from('Portefeuille')
                .update({ current_price: newCash })
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', 'CASH');

            if (cashError) {
                throw new Error(cashError.message || 'Cash bijwerken mislukt');
            }

            tradeContext.quantity = newQty;
            tradeContext.avgPrice = newAvg;
            tradeContext.fee = newFeeTotal;
            if (lastCashRow) {
                lastCashRow.current_price = newCash;
            }
            await logTrade({ type: 'BUY', ticker: tradeContext.ticker, aantal: qty, koers: price });
            if (fee && fee > 0) {
                await logTrade({ type: 'FEE', ticker: tradeContext.ticker, aantal: 1, koers: fee });
            }
        }

        async function processSell(qty, price, fee) {
            const currentQty = Number(tradeContext.quantity) || 0;
            if (qty > currentQty) {
                throw new Error('Niet genoeg aandelen om te verkopen.');
            }
            const proceeds = qty * price - fee;
            if (proceeds < 0) {
                throw new Error('Transactie resulteert in negatief bedrag.');
            }
            const newQty = currentQty - qty;
            const currentFee = Number(tradeContext.fee) || 0;
            const newFeeTotal = currentFee + fee;

            if (newQty > 0) {
                const { error } = await applyPositionFilter(
                    supabase
                        .from('Portefeuille')
                        .update({
                            quantity: newQty,
                            current_price: price,
                            transactiekost: newFeeTotal
                        })
                        .eq('groep_id', ACTIVE_GROUP_ID)
                );
                if (error) {
                    throw new Error(error.message || 'Positie bijwerken mislukt');
                }
            } else {
                const { error } = await applyPositionFilter(
                    supabase
                        .from('Portefeuille')
                        .update({
                            quantity: 0,
                            current_price: price,
                            transactiekost: newFeeTotal
                        })
                        .eq('groep_id', ACTIVE_GROUP_ID)
                );
                if (error) {
                    throw new Error(error.message || 'Positie bijwerken (naar 0) mislukt');
                }
            }

            const cashCurrent = Number(lastCashRow?.current_price) || 0;
            const newCash = cashCurrent + proceeds;
            const { error: cashError } = await supabase
                .from('Portefeuille')
                .update({ current_price: newCash })
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', 'CASH');
            if (cashError) {
                throw new Error(cashError.message || 'Cash bijwerken mislukt');
            }

            tradeContext.quantity = newQty;
            tradeContext.fee = newFeeTotal;
            if (lastCashRow) {
                lastCashRow.current_price = newCash;
            }
            await logTrade({ type: 'SELL', ticker: tradeContext.ticker, aantal: qty, koers: price });
            if (fee && fee > 0) {
                await logTrade({ type: 'FEE', ticker: tradeContext.ticker, aantal: 1, koers: fee });
            }
        }

        async function logTrade(details) {
            try {
                let cur = (currencyInput?.value || lastQuote?.currency || 'EUR').trim().toUpperCase();
                if (!cur.match(/^[A-Z]{2,6}$/)) {
                    cur = 'EUR';
                }
                const wkVal = (parseFloat(document.getElementById('wk-output')?.value || '0') || 1);
                const body = {
                    type: details.type,
                    ticker: details.ticker,
                    aantal: details.aantal,
                    koers: details.koers,
                    wisselkoers: wkVal,
                    munt: cur,
                    datum_tr: (transactionDateInput?.value || null),
                    portefeuille_id: tradeContext?.positionId || null
                };
                const resp = await fetch('/api/transactions/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!resp.ok) {
                    try {
                        const msg = await resp.text();
                        console.warn('Transactie log mislukt:', resp.status, msg);
                    } catch (e) {
                        console.warn('Transactie log mislukt:', resp.status);
                    }
                }
            } catch (e) {
                console.debug('Transactie log mislukt', e);
            }
        }

        function updateCashCard(amount) {
            const cashEl = document.getElementById('cash-balance');
            if (cashEl) cashEl.textContent = eur.format(amount);
            if (amount > 0) {
                setCashStatus('Klaar om te investeren', 'info');
            } else {
                setCashStatus('Geen cash beschikbaar', 'error');
            }
        }

        async function ensureCashRow() {
            if (!ACTIVE_GROUP_ID) return false;
            try {
                const lastRow = await fetchLatestCashRow();
                if (lastRow) {
                    lastCashRow = lastRow;
                    return true;
                }
                const payload = {
                    ticker: "CASH",
                    name: "Cash",
                    sector: "Cash",
                    quantity: 0,
                    avg_price: 0,
                    current_price: 0,
                    transactiekost: 0,
                    groep_id: ACTIVE_GROUP_ID
                };
                
                const { data, error } = await supabase.from('Portefeuille').insert([payload]).select();
                
                if (error) {
                    console.warn("Kon geen cash row aanmaken (mogelijk geen rechten):", error);
                    return false;
                }
                
                if (data && data[0]) {
                    lastCashRow = data[0];
                    return true;
                }
                return false;
                
            } catch (err) {
                console.error('Cashpositie check mislukt:', err);
                return false;
            }
        }

        function setCashControlsState(enabled) {
            const flag = enabled && ACTIVE_GROUP_ID && IS_HOST;
            if (cashAdjustInput) cashAdjustInput.disabled = !flag;
            if (cashAddBtn) cashAddBtn.disabled = !flag;
            if (cashRemoveBtn) cashRemoveBtn.disabled = !flag;
        }

        function setCashStatus(message, type = 'info') {
            const statusEl = document.getElementById('cash-status');
            if (!statusEl) return;
            const colors = {
                info: 'text-slate-400',
                success: 'text-emerald-600',
                error: 'text-rose-600'
            };
            statusEl.textContent = message;
            statusEl.className = 'text-xs ' + (colors[type] || colors.info);
        }

        async function handleCashAdjust(mode) {
            if (!ACTIVE_GROUP_ID) {
                setCashStatus('Selecteer eerst een groep', 'error');
                return;
            }
            if (!lastCashRow) {
                setCashStatus('Cashpositie niet gevonden, opnieuw laden...', 'info');
                await ensureCashRow();
                lastCashRow = await fetchLatestCashRow();
                if (!lastCashRow) {
                    setCashStatus('Cashpositie kon niet worden gevonden.', 'error');
                    return;
                }
                updateCashCard(Number(lastCashRow.current_price) || 0);
            }
            const raw = parseFloat(cashAdjustInput?.value || '0');
            if (!raw || raw <= 0) {
                setCashStatus('Voer een bedrag groter dan 0 in', 'error');
                return;
            }
            const current = Number(lastCashRow.current_price) || 0;
            const delta = mode === 'add' ? raw : -raw;
            const next = current + delta;
            if (next < 0) {
                setCashStatus('Cash kan niet negatief worden', 'error');
                return;
            }
            setCashStatus('Cash bijwerken...', 'info');
            const { error } = await supabase
                .from('Portefeuille')
                .update({ current_price: next })
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', 'CASH');
            if (error) {
                console.error('Cash update mislukt', error);
                setCashStatus(error.message || 'Cash bijwerken mislukt', 'error');
                return;
            }
            if (cashAdjustInput) cashAdjustInput.value = '';
            setCashStatus('Cash aangepast', 'success');
            
            fetchPortfolio();
        }

        async function fetchLatestCashRow() {
            if (!ACTIVE_GROUP_ID) return null;
            const { data, error } = await supabase
                .from('Portefeuille')
                .select('*')
                .eq('groep_id', ACTIVE_GROUP_ID)
                .eq('ticker', 'CASH')
                .limit(1);
            if (error) {
                console.error('Cash ophalen mislukt', error);
                return null;
            }
            return data?.[0] || null;
        }

        fetchPortfolio();
    </script>
</body>
</html>